<html><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>Scala Effekt</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Extensible algebraic effects with handlers" /><meta name="author" content="Jonathan Brachthäuser (@b-studios)" /><meta name="og:image" content="/scala-effekt/img/poster.png" /><meta name="og:title" content="Scala Effekt" /><meta name="og:site_name" content="Scala Effekt" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Extensible algebraic effects with handlers" /><meta name="twitter:image" content="/scala-effekt/img/poster.png" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="" /><meta name="kazari-dependencies" content="" /><meta name="kazari-resolvers" content="" /><link rel="icon" type="image/png" href="/scala-effekt/img/favicon.png" /><link rel="icon" type="image/png" sizes="16x16" href="/scala-effekt/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/scala-effekt/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/scala-effekt/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/scala-effekt/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/scala-effekt/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/scala-effekt/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/scala-effekt/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/scala-effekt/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/scala-effekt/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/scala-effekt/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/scala-effekt/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/scala-effekt/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/scala-effekt/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/scala-effekt/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/scala-effekt/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/scala-effekt/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/scala-effekt/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/scala-effekt/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/scala-effekt/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/scala-effekt/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/scala-effekt/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/scala-effekt/css/style.css" /><link rel="stylesheet" href="/scala-effekt/css/palette.css" /><link rel="stylesheet" href="/scala-effekt/css/codemirror.css" /><link rel="stylesheet" href="/scala-effekt/css/kazari-style.css" /><link rel="stylesheet" href="/scala-effekt/css/solarized-dark.css" /><link rel="stylesheet" href="/scala-effekt/css/boilerplate.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/scala-effekt/" class="brand"><div class="brand-wrapper"><span>Scala Effekt</span></div></a></li> <li><a href="/scala-effekt/guides.html" class="">Guides</a></li> <li><a href="/scala-effekt/guides/getting-started.html" class="">Getting Started</a></li> <li><a href="/scala-effekt/guides/multiple-effects.html" class="">Multiple Effects</a></li> <li><a href="/scala-effekt/guides/multiple-handlers.html" class="">Multiple Handlers at Once</a></li> <li><a href="/scala-effekt/guides/a-normal-form.html" class="">Example: ANF Transformation</a></li> <li><a href="/scala-effekt/guides/piping.html" class="">Example: Piping</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/b-studios/scala-effekt"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/b-studios/scala-effekt"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Scala Effekt Extensible algebraic effects with handlers');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Scala Effekt Extensible algebraic effects with handlers');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="b-studios" data-github-repo="scala-effekt"><div class="content-wrapper"><section><h1 id="pipes-connecting-producers-and-consumers">Pipes: Connecting Producers and Consumers</h1>
<p>In this quick guide, we’ll re-implement the piping example from the
paper <a href="http://homepages.inf.ed.ac.uk/slindley/papers/handlers.pdf">“Handlers in Action”</a>
by Ohad Kammar and colleagues.
In particular, we are interested in treating sending and receiving of
information as effects.
For simplicity, we’ll restrict ourselves to the case where the sent
information is of type <code class="highlighter-rouge">Int</code>.</p>

<p>First of all, let’s define the effect signatures for sending and
receiving of information:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">effekt._</span>

<span class="k">trait</span> <span class="nc">Send</span> <span class="k">extends</span> <span class="nc">Eff</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Op</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">Receive</span> <span class="k">extends</span> <span class="nc">Eff</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span><span class="o">()</span><span class="k">:</span> <span class="kt">Op</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<span class="o">}</span>
</code></pre>
</div>

<div class="language-scala boilerplate highlighter-rouge"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Send</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">u</span><span class="k">:</span> <span class="kt">Use</span><span class="o">[</span><span class="kt">Send</span><span class="o">])</span> <span class="k">=</span> <span class="n">use</span><span class="o">(</span><span class="n">u</span><span class="o">)</span> <span class="o">{</span> <span class="n">u</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">send</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Receive</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span><span class="o">()(</span><span class="k">implicit</span> <span class="n">u</span><span class="k">:</span> <span class="kt">Use</span><span class="o">[</span><span class="kt">Receive</span><span class="o">])</span> <span class="k">=</span> <span class="n">use</span><span class="o">(</span><span class="n">u</span><span class="o">)</span> <span class="o">{</span> <span class="n">u</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">receive</span><span class="o">()</span> <span class="o">}</span>
<span class="o">}</span>
<span class="k">import</span> <span class="nn">Send._</span><span class="o">,</span> <span class="nc">Receive</span><span class="o">.</span><span class="k">_</span>
</code></pre>
</div>

<p>Now, using these effect signatures we can define an example producer and
a corresponding example consumer:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">producer</span><span class="o">(</span><span class="k">implicit</span> <span class="n">s</span><span class="k">:</span> <span class="kt">Use</span><span class="o">[</span><span class="kt">Send</span><span class="o">])</span><span class="k">:</span> <span class="kt">Control</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">send</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">send</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">send</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>

<span class="k">def</span> <span class="n">consumer</span><span class="o">(</span><span class="k">implicit</span> <span class="n">s</span><span class="k">:</span> <span class="kt">Use</span><span class="o">[</span><span class="kt">Receive</span><span class="o">])</span><span class="k">:</span> <span class="kt">Control</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">x1</span> <span class="k">&lt;-</span> <span class="n">receive</span><span class="o">()</span>
    <span class="k">_</span> <span class="k">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"1: "</span> <span class="o">+</span> <span class="n">x1</span><span class="o">)</span>
    <span class="n">x2</span> <span class="k">&lt;-</span> <span class="n">receive</span><span class="o">()</span>
    <span class="k">_</span> <span class="k">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"2: "</span> <span class="o">+</span> <span class="n">x2</span><span class="o">)</span>
    <span class="n">x3</span> <span class="k">&lt;-</span> <span class="n">receive</span><span class="o">()</span>
    <span class="k">_</span> <span class="k">=</span> <span class="n">println</span><span class="o">(</span><span class="s">"3: "</span> <span class="o">+</span> <span class="n">x3</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="o">()</span>
</code></pre>
</div>

<p>What is missing, is a way to connect the two in order to form a pipe.
The core insight to achieve this the following:
The two ends of a pipe are connected by holding a reference to the
opposite end as part of their internal state.
After performing an
action, such as sending or receiving data, the current process is
paused and the state of the opposite process is updated with the
current continuation.</p>

<p>Now let’s implement this behavior in Effekt. To this end, we define
processes as handlers and use the state of the handler to store the
opposite end:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">R0</span>, <span class="kt">P</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="nc">extends</span> <span class="nc">Handler</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">R</span>     <span class="o">=</span> <span class="n">R0</span>
  <span class="k">type</span> <span class="kt">Res</span>   <span class="o">=</span> <span class="n">R</span>
  <span class="k">type</span> <span class="kt">State</span> <span class="o">=</span> <span class="n">P</span><span class="o">[</span><span class="kt">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">]]</span>
  <span class="k">def</span> <span class="n">unit</span> <span class="k">=</span> <span class="n">identity</span>
<span class="o">}</span>
</code></pre>
</div>
<p>In our case, the type constructor <code class="highlighter-rouge">P[_]</code> will be one of the following:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Process</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Prod</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">apply</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=&gt;</span> <span class="nc">Cons</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="n">R</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Cons</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">apply</span><span class="k">:</span> <span class="kt">Int</span>  <span class="o">=&gt;</span> <span class="nc">Prod</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="n">R</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">import</span> <span class="nn">Process._</span>
</code></pre>
</div>
<p>Note that each process holds a <strong>continuation</strong> which takes the resulting
value as first argument <strong>and the updated opposite process</strong> as state
(second argument) to finally compute an <code class="highlighter-rouge">R</code>. As can be seen in the
definition of <code class="highlighter-rouge">Process</code> above, the <code class="highlighter-rouge">R</code> will eventually be instantiated
as <code class="highlighter-rouge">Control[R0]</code> since it needs to be effectful.</p>

<p>The two handlers corresponding to receiving and producing processes
now can be defined as:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">down</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Receive</span> <span class="k">with</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">Prod</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">receive</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Prod</span><span class="o">(</span><span class="n">prod</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">resume</span> <span class="k">=&gt;</span> <span class="n">prod</span><span class="o">(())(</span><span class="nc">Cons</span><span class="o">(</span><span class="n">resume</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">up</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Send</span> <span class="k">with</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">Cons</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">send</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Cons</span><span class="o">(</span><span class="n">cons</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">resume</span> <span class="k">=&gt;</span> <span class="n">cons</span><span class="o">(</span><span class="n">n</span><span class="o">)(</span><span class="nc">Prod</span><span class="o">(</span><span class="n">resume</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>Stunning symmetry, isn’t it? :)</p>

<p>Finally, the pipe can be created by connecting <code class="highlighter-rouge">up</code> and <code class="highlighter-rouge">down</code> to
handle two program fragments using <code class="highlighter-rouge">Receive</code> and <code class="highlighter-rouge">Send</code> correspondingly.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">pipe</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">d</span><span class="k">:</span> <span class="kt">Use</span><span class="o">[</span><span class="kt">Receive</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">],</span> <span class="n">u</span><span class="k">:</span> <span class="kt">Use</span><span class="o">[</span><span class="kt">Send</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">])</span><span class="k">:</span> <span class="kt">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">down</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="nc">Prod</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">cons</span> <span class="k">=&gt;</span> <span class="n">up</span><span class="o">(</span><span class="n">cons</span><span class="o">)</span> <span class="o">{</span> <span class="n">u</span> <span class="o">}))</span> <span class="o">{</span> <span class="n">d</span> <span class="o">}</span>
</code></pre>
</div>
<p>Running our above example with <code class="highlighter-rouge">pipe</code> yields:</p>
<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="n">pipe</span><span class="o">(</span><span class="n">d</span> <span class="k">=&gt;</span> <span class="n">consumer</span><span class="o">(</span><span class="n">d</span><span class="o">),</span> <span class="n">u</span> <span class="k">=&gt;</span> <span class="n">producer</span><span class="o">(</span><span class="n">u</span><span class="o">)).</span><span class="n">run</span><span class="o">()</span>
<span class="mi">1</span><span class="k">:</span> <span class="err">1</span>
<span class="err">2</span><span class="kt">:</span> <span class="err">2</span>
<span class="err">3</span><span class="kt">:</span> <span class="err">3</span>
</code></pre>
</div>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/scala-effekt/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/scala-effekt/js/boilerplate.js"></script><script src="/scala-effekt/js/main.js"></script><script src="/scala-effekt/js/kazari.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'solarized-dark')
})
    </script></body></html>