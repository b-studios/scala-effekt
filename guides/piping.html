<!DOCTYPE html><html><head><title>Scala Effekt: Pipes: Connecting Producers and Consumers</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Jonathan Brachthäuser (@b-studios)" /><meta name="description" content="Extensible algebraic effects with handlers" /><meta name="og:image" content="/scala-effekt/img/poster.png" /><meta name="image" property="og:image" content="/scala-effekt/img/poster.png" /><meta name="og:title" content="Scala Effekt: Pipes: Connecting Producers and Consumers" /><meta name="title" property="og:title" content="Scala Effekt: Pipes: Connecting Producers and Consumers" /><meta name="og:site_name" content="Scala Effekt" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Extensible algebraic effects with handlers" /><link rel="icon" type="image/png" href="/scala-effekt/img/favicon.png" /><meta name="twitter:title" content="Scala Effekt: Pipes: Connecting Producers and Consumers" /><meta name="twitter:image" content="/scala-effekt/img/poster.png" /><meta name="twitter:description" content="Extensible algebraic effects with handlers" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/scala-effekt/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/scala-effekt/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/scala-effekt/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/scala-effekt/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/scala-effekt/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/scala-effekt/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/scala-effekt/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/scala-effekt/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/scala-effekt/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/scala-effekt/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/scala-effekt/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/scala-effekt/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/scala-effekt/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/scala-effekt/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/scala-effekt/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/scala-effekt/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/scala-effekt/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/scala-effekt/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/scala-effekt/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/scala-effekt/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/scala-effekt/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/scala-effekt/css/light-style.css" /><link rel="stylesheet" href="/scala-effekt/css/boilerplate.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/scala-effekt/" class="brand"><div class="brand-wrapper"></div><span>Scala Effekt</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/scala-effekt/guides.html" title="Guides" class="">Guides</a></div> <div class="sidebar-nav-item  "><a href="/scala-effekt/guides/getting-started.html" title="Getting Started" class="">Getting Started</a></div> <div class="sidebar-nav-item  "><a href="/scala-effekt/guides/multiple-effects.html" title="Multiple Effects" class="">Multiple Effects</a></div> <div class="sidebar-nav-item  "><a href="/scala-effekt/guides/multiple-handlers.html" title="Multiple Handlers at Once" class="">Multiple Handlers at Once</a></div> <div class="sidebar-nav-item  "><a href="/scala-effekt/guides/a-normal-form.html" title="Example: ANF Transformation" class="">Example: ANF Transformation</a></div> <div class="sidebar-nav-item active "><a href="/scala-effekt/guides/piping.html" title="Example: Piping" class="active">Example: Piping</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/b-studios/scala-effekt" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/b-studios/scala-effekt" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="b-studios" data-github-repo="scala-effekt"><div class="content-wrapper"><section><h1 id="pipes-connecting-producers-and-consumers">Pipes: Connecting Producers and Consumers</h1>

<p>In this quick guide, we’ll re-implement the piping example from the
paper <a href="http://homepages.inf.ed.ac.uk/slindley/papers/handlers.pdf">“Handlers in Action”</a>
by Ohad Kammar and colleagues.
In particular, we are interested in treating sending and receiving of
information as effects.
For simplicity, we’ll restrict ourselves to the case where the sent
information is of type <code class="language-plaintext highlighter-rouge">Int</code>.</p>

<p>First of all, let’s define the effect signatures for sending and
receiving of information:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">effekt._</span>

<span class="k">trait</span> <span class="nc">Send</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">send</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Control</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
<span class="o">}</span>
<span class="k">trait</span> <span class="nc">Receive</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">receive</span><span class="o">()</span><span class="k">:</span> <span class="kt">Control</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now, using these effect signatures we can define an example producer and
a corresponding example consumer:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">producer</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">Send</span><span class="o">)</span><span class="k">:</span> <span class="kt">Control</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">s</span><span class="o">.</span><span class="py">send</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">s</span><span class="o">.</span><span class="py">send</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">s</span><span class="o">.</span><span class="py">send</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>

<span class="k">def</span> <span class="nf">consumer</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">Receive</span><span class="o">)</span><span class="k">:</span> <span class="kt">Control</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">x1</span> <span class="k">&lt;-</span> <span class="nv">r</span><span class="o">.</span><span class="py">receive</span><span class="o">()</span>
    <span class="k">_</span> <span class="k">=</span> <span class="nf">println</span><span class="o">(</span><span class="s">"1: "</span> <span class="o">+</span> <span class="n">x1</span><span class="o">)</span>
    <span class="n">x2</span> <span class="k">&lt;-</span> <span class="nv">r</span><span class="o">.</span><span class="py">receive</span><span class="o">()</span>
    <span class="k">_</span> <span class="k">=</span> <span class="nf">println</span><span class="o">(</span><span class="s">"2: "</span> <span class="o">+</span> <span class="n">x2</span><span class="o">)</span>
    <span class="n">x3</span> <span class="k">&lt;-</span> <span class="nv">r</span><span class="o">.</span><span class="py">receive</span><span class="o">()</span>
    <span class="k">_</span> <span class="k">=</span> <span class="nf">println</span><span class="o">(</span><span class="s">"3: "</span> <span class="o">+</span> <span class="n">x3</span><span class="o">)</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
</code></pre></div></div>

<p>What is missing, is a way to connect the two in order to form a pipe.
The core insight to achieve this the following:
The two ends of a pipe are connected by holding a reference to the
opposite end as part of their internal state.
After performing an
action, such as sending or receiving data, the current process is
paused and the state of the opposite process is updated with the
current continuation.</p>

<p>Now let’s implement this behavior in Effekt. To this end, we define
processes as handlers and use the state of the handler to store the
opposite end:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">P</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">val</span> <span class="nv">init</span><span class="k">:</span> <span class="kt">P</span><span class="o">[</span><span class="kt">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">]])</span> <span class="k">extends</span> <span class="nv">Handler</span><span class="o">.</span><span class="py">Stateful</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">P</span><span class="o">[</span><span class="kt">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">]]]</span>
</code></pre></div></div>
<p>In our case, the type constructor <code class="language-plaintext highlighter-rouge">P[_]</code> will be one of the following:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Process</span> <span class="o">{</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Prod</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">apply</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=&gt;</span> <span class="nc">Cons</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="n">R</span><span class="o">)</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Cons</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">apply</span><span class="k">:</span> <span class="kt">Int</span>  <span class="o">=&gt;</span> <span class="nc">Prod</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="n">R</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">import</span> <span class="nn">Process._</span>
</code></pre></div></div>
<p>Note that each process holds a <strong>continuation</strong> which takes the resulting
value as first argument <strong>and the updated opposite process</strong> as state
(second argument) to finally compute an <code class="language-plaintext highlighter-rouge">R</code>. As can be seen in the
definition of <code class="language-plaintext highlighter-rouge">Process</code> above, the <code class="language-plaintext highlighter-rouge">R</code> will eventually be instantiated
as <code class="language-plaintext highlighter-rouge">Control[R0]</code> since it needs to be effectful.</p>

<p>The two handlers corresponding to receiving and producing processes
now can be defined as:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">down</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">p</span><span class="k">:</span> <span class="kt">Prod</span><span class="o">[</span><span class="kt">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">]])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">Prod</span><span class="o">](</span><span class="n">p</span><span class="o">)</span> <span class="k">with</span> <span class="nc">Receive</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">receive</span><span class="o">()</span> <span class="k">=</span> <span class="n">useState</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Prod</span><span class="o">(</span><span class="n">prod</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">resume</span> <span class="k">=&gt;</span> <span class="nf">prod</span><span class="o">(())(</span><span class="nc">Cons</span><span class="o">(</span><span class="n">resume</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>


<span class="k">def</span> <span class="nf">up</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">p</span><span class="k">:</span> <span class="kt">Cons</span><span class="o">[</span><span class="kt">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">]])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">Cons</span><span class="o">](</span><span class="n">p</span><span class="o">)</span> <span class="k">with</span> <span class="nc">Send</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">send</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">useState</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Cons</span><span class="o">(</span><span class="n">cons</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">resume</span> <span class="k">=&gt;</span> <span class="nf">cons</span><span class="o">(</span><span class="n">n</span><span class="o">)(</span><span class="nc">Prod</span><span class="o">(</span><span class="n">resume</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Stunning symmetry, isn’t it? :)</p>

<p>Finally, the pipe can be created by connecting <code class="language-plaintext highlighter-rouge">up</code> and <code class="language-plaintext highlighter-rouge">down</code> to
handle two program fragments using <code class="language-plaintext highlighter-rouge">Receive</code> and <code class="language-plaintext highlighter-rouge">Send</code> correspondingly.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">pipe</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">d</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=&gt;</span> <span class="nc">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">],</span> <span class="n">u</span><span class="k">:</span> <span class="kt">Send</span> <span class="o">=&gt;</span> <span class="nc">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">])</span><span class="k">:</span> <span class="kt">Control</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">down</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="nc">Prod</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">cons</span> <span class="k">=&gt;</span> <span class="nf">up</span><span class="o">(</span><span class="n">cons</span><span class="o">)</span> <span class="o">{</span> <span class="n">u</span> <span class="o">}))</span> <span class="o">{</span> <span class="n">d</span> <span class="o">}</span>
</code></pre></div></div>
<p>Running our above example with <code class="language-plaintext highlighter-rouge">pipe</code> yields:</p>
<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">pipe</span><span class="o">(</span><span class="n">d</span> <span class="k">=&gt;</span> <span class="nf">consumer</span><span class="o">(</span><span class="n">d</span><span class="o">),</span> <span class="n">u</span> <span class="k">=&gt;</span> <span class="nf">producer</span><span class="o">(</span><span class="n">u</span><span class="o">)).</span><span class="py">run</span><span class="o">()</span>
<span class="c1">// 1: 1</span>
<span class="c1">// 2: 2</span>
<span class="c1">// 3: 3</span>
</code></pre></div></div>
</section></div></div></div></div><script src="/scala-effekt/highlight/highlight.pack.js"></script><script src="/scala-effekt/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script src="/scala-effekt/js/boilerplate.js"></script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'b-studios/scala-effekt'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/scala-effekt/js/search.js"></script><script src="/scala-effekt/js/docs.js"></script></body></html>